package edu.kit.ipd.sdq.kamp4attack.tests.change.vulnerability;

import static org.junit.Assert.assertTrue;
import static org.junit.jupiter.api.Assertions.assertEquals;

import org.eclipse.emf.ecore.util.EcoreUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.attackSpecification.AttackVector;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.attackSpecification.ConfidentialityImpact;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.attackSpecification.Privileges;
import org.palladiosimulator.pcm.confidentiality.attackerSpecification.pcmIntegration.PcmIntegrationFactory;
import org.palladiosimulator.pcm.confidentiality.context.system.pcm.structure.StructureFactory;
import org.palladiosimulator.pcm.repository.BasicComponent;
import org.palladiosimulator.pcm.resourceenvironment.LinkingResource;
import org.palladiosimulator.pcm.seff.ResourceDemandingSEFF;

import edu.kit.ipd.sdq.kamp4attack.core.changepropagation.changes.LinkingPropagationVulnerability;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CompromisedLinkingResource;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CredentialChange;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.KAMP4attackModificationmarksFactory;
import edu.kit.ipd.sdq.kamp4attack.tests.change.AbstractChangeTests;

public class PropagationLinkingResourceTest extends AbstractChangeTests {
    private void runLinkingAssemblyPropagation(final CredentialChange change) {
        final var wrapper = getBlackboardWrapper();
        final var assemblyChange = new LinkingPropagationVulnerability(wrapper, change);
        assemblyChange.calculateLinkingResourceToAssemblyContextPropagation();
    }

    private void runLinkingResourcePropagation(final CredentialChange change) {
        final var wrapper = getBlackboardWrapper();
        final var assemblyChange = new LinkingPropagationVulnerability(wrapper, change);
        assemblyChange.calculateLinkingResourceToResourcePropagation();
    }

    protected CompromisedLinkingResource createLinking(final CredentialChange change) {
        return this.createLinking(change, this.environment.getLinkingResources__ResourceEnvironment().get(0));
    }

    protected CompromisedLinkingResource createLinking(final CredentialChange change,
            final LinkingResource assemblyComponent) {
        final var infectedLinking = KAMP4attackModificationmarksFactory.eINSTANCE.createCompromisedLinkingResource();
        final var assemblyContext = assemblyComponent;
        infectedLinking.setAffectedElement(assemblyContext);
        change.getCompromisedlinkingresource().add(infectedLinking);
        return infectedLinking;
    }

    @BeforeEach
    void initXML() {
        generateXML();
    }

    @Test
    void LinkingToAssemblyPropagation() {
        final var change = KAMP4attackModificationmarksFactory.eINSTANCE.createCredentialChange();

        final var cweID = createSimpleAttack();

        final var vulnerability = createCWEVulnerability(cweID, AttackVector.NETWORK, Privileges.NONE,
                ConfidentialityImpact.HIGH, true, null);

        final var compromisedLinking = this.createLinking(change);

        final var integration = PcmIntegrationFactory.eINSTANCE.createVulnerabilitySystemIntegration();
        final var pcmElement = PcmIntegrationFactory.eINSTANCE.createPCMElement();
        integration.setPcmelement(pcmElement);
        integration.setVulnerability(vulnerability);
        pcmElement.setAssemblycontext(this.assembly.getAssemblyContexts__ComposedStructure().get(2));
        this.attacker.getSystemintegration().getVulnerabilities().add(integration);

        runLinkingAssemblyPropagation(change);

        assertTrue(change.getCompromisedresource().isEmpty());
        assertEquals(1, change.getCompromisedlinkingresource().size());
        assertTrue(EcoreUtil.equals(change.getCompromisedlinkingresource().get(0), compromisedLinking));
        assertEquals(1, change.getCompromisedassembly().size());
        assertTrue(EcoreUtil.equals(change.getCompromisedassembly().get(0).getAffectedElement().getCompromisedComponents().get(0),
                this.assembly.getAssemblyContexts__ComposedStructure().get(2)));
        assertTrue(change.isChanged());
    }

    @Test
    void LinkingToAssemblyPropagationSEFF() {
        final var change = KAMP4attackModificationmarksFactory.eINSTANCE.createCredentialChange();

        final var cweID = createSimpleAttack();

        final var vulnerability = createCWEVulnerability(cweID, AttackVector.NETWORK, Privileges.NONE,
                ConfidentialityImpact.HIGH, true, null);

        final var compromisedLinking = this.createLinking(change);

        final var methodSpecification = StructureFactory.eINSTANCE.createServiceRestriction();
        final var seff = ((BasicComponent) this.assembly.getAssemblyContexts__ComposedStructure().get(2)
                .getEncapsulatedComponent__AssemblyContext()).getServiceEffectSpecifications__BasicComponent().get(0);
        methodSpecification.setAssemblycontext(this.assembly.getAssemblyContexts__ComposedStructure().get(2));
        methodSpecification.setService((ResourceDemandingSEFF) seff);
        methodSpecification.setSignature(seff.getDescribedService__SEFF());

        final var integration = PcmIntegrationFactory.eINSTANCE.createVulnerabilitySystemIntegration();
        var element = PcmIntegrationFactory.eINSTANCE.createPCMElement();
        element.setMethodspecification(methodSpecification);
        integration.setVulnerability(vulnerability);
        integration.setPcmelement(element);
        this.attacker.getSystemintegration().getVulnerabilities().add(integration);

        runLinkingAssemblyPropagation(change);

        assertTrue(change.getCompromisedresource().isEmpty());
        assertEquals(1, change.getCompromisedlinkingresource().size());
        assertTrue(EcoreUtil.equals(change.getCompromisedlinkingresource().get(0), compromisedLinking));
        assertEquals(1, change.getCompromisedassembly().size());
		assertTrue(EcoreUtil.equals(change.getCompromisedassembly().get(0).getAffectedElement()
				.getCompromisedComponents().get(0),
                this.assembly.getAssemblyContexts__ComposedStructure().get(2)));
        assertTrue(change.isChanged());
    }

    @Test
    void LinkingToResourcePropagation() {
        final var change = KAMP4attackModificationmarksFactory.eINSTANCE.createCredentialChange();

        final var cweID = createSimpleAttack();

        final var vulnerability = createCWEVulnerability(cweID, AttackVector.NETWORK, Privileges.NONE,
                ConfidentialityImpact.HIGH, true, null);

        final var compromisedLinking = this.createLinking(change);

        final var integration = PcmIntegrationFactory.eINSTANCE.createVulnerabilitySystemIntegration();
        final var pcmElement = PcmIntegrationFactory.eINSTANCE.createPCMElement();
        integration.setPcmelement(pcmElement);
        integration.setVulnerability(vulnerability);
        pcmElement.setResourcecontainer(this.environment.getResourceContainer_ResourceEnvironment().get(1));
        this.attacker.getSystemintegration().getVulnerabilities().add(integration);

        runLinkingResourcePropagation(change);

        assertEquals(1, change.getCompromisedresource().size());
        assertTrue(EcoreUtil.equals(change.getCompromisedresource().get(0).getAffectedElement(),
                this.environment.getResourceContainer_ResourceEnvironment().get(1)));
        assertEquals(1, change.getCompromisedlinkingresource().size());
        assertTrue(EcoreUtil.equals(change.getCompromisedlinkingresource().get(0), compromisedLinking));
        assertTrue(change.getCompromisedassembly().isEmpty());
        assertTrue(change.isChanged());
    }
}
